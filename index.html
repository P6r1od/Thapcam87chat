<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>NM Chat Realtime</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
    }
    .container {
      display: flex;
      height: 100vh;
    }
    .left {
      flex: 3;
      display: flex;
      flex-direction: column;
      background-color: #ffffff;
      padding: 10px;
    }
    #chatBox {
      flex: 1;
      border: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
      background-color: #fff;
    }
    .msg {
      margin-bottom: 10px;
      word-wrap: break-word;
    }
    .msg strong {
      font-weight: bold;
    }
    .bottom-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      padding: 10px;
      background-color: #eee;
    }
    .bottom-bar input[type="text"] {
      flex: 1;
      padding: 8px;
      font-size: 16px;
      border: 1px solid #aaa;
    }
    .bottom-bar button {
      padding: 8px 16px;
      font-size: 16px;
    }
    .right {
      flex: 1;
      background-color: #f9f9f9;
      border-left: 1px solid #ccc;
      padding: 10px;
    }
    .right h2 {
      margin-top: 0;
    }
    #userList {
      list-style: none;
      padding: 0;
    }
    .typing-status {
      font-style: italic;
      color: gray;
      padding-left: 10px;
    }
    @media (max-width: 600px) {
      .container { flex-direction: column; }
      .bottom-bar { flex-direction: column; }
      .bottom-bar input, .bottom-bar button { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="left">
      <div id="chatBox"></div>
      <div id="typingStatus" class="typing-status"></div>
      <div class="bottom-bar">
        <input type="text" id="nickname" placeholder="T√™n (m·∫∑c ƒë·ªãnh: ·∫®n danh)">
        <input type="text" id="message" placeholder="Nh·∫≠p tin nh·∫Øn...">
        <input type="file" id="imageInput" accept="image/*">
        <button onclick="window.sendMessage()">G·ª≠i</button>
        <button id="clearBtn" onclick="window.clearChat()" style="display:none;">üßπ X√≥a t·∫•t c·∫£</button>
      </div>
    </div>
    <div class="right">
      <p style="font-size:12px; color:gray; font-style:italic;">
        * Tin nh·∫Øn ƒë∆∞·ª£c l∆∞u tr√™n ƒë√°m m√¢y v√† s·∫Ω hi·ªÉn th·ªã l·∫°i khi truy c·∫≠p l·∫°i trang. T√™n ng∆∞·ªùi d√πng ƒë∆∞·ª£c kh√≥a trong 1 tr√¨nh duy·ªát ƒë·ªÉ tr√°nh nh·∫ßm l·∫´n.
      </p>
      <h2>Th√†nh vi√™n</h2>
      <ul id="userList"></ul>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getDatabase, ref, push, onChildAdded, remove, set, onValue
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
    import {
      getStorage, ref as sRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

    const config = {
      apiKey: "AIzaSyAwz09EQouPZsgxnIQaAKiGfUKrlbbd7sM",
      authDomain: "thapcamchat.firebaseapp.com",
      databaseURL: "https://thapcamchat-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "thapcamchat",
      storageBucket: "thapcamchat.appspot.com",
      messagingSenderId: "832278442913",
      appId: "1:832278442913:web:b24e7b6d7b283e9885d1e0"
    };

    const app = initializeApp(config);
    const db = getDatabase(app);
    const storage = getStorage(app);
    const messagesRef = ref(db, "messages");
    const typingRef = ref(db, "typing");

    const chatBox = document.getElementById("chatBox");
    const messageInput = document.getElementById("message");
    const nicknameInput = document.getElementById("nickname");
    const typingStatus = document.getElementById("typingStatus");
    const userList = document.getElementById("userList");
    const clearBtn = document.getElementById("clearBtn");
    const imageInput = document.getElementById("imageInput");

    const userColorMap = {};
    const activeUsers = new Set();
    let isAdmin = false;
    let lastSentTime = 0;

    function getColorForUser(name) {
      if (!userColorMap[name]) {
        userColorMap[name] = `hsl(${Math.random() * 360}, 70%, 50%)`;
      }
      return userColorMap[name];
    }

    window.sendMessage = async function () {
      let nickname = localStorage.getItem("lockedName") || nicknameInput.value.trim() || "·∫®n danh";
      if (!localStorage.getItem("lockedName")) {
        if ([...activeUsers].includes(nickname)) {
          alert("T√™n ƒë√£ t·ªìn t·∫°i. Vui l√≤ng ch·ªçn t√™n kh√°c.");
          return;
        }
        localStorage.setItem("lockedName", nickname);
      }
      nicknameInput.value = nickname;
      nicknameInput.disabled = true;

      const message = messageInput.value.trim();
      const file = imageInput.files[0];
      if (!message && !file) return;

      const now = Date.now();
      if (now - lastSentTime < 5000) {
        alert("Vui l√≤ng ch·ªù 5 gi√¢y gi·ªØa c√°c tin nh·∫Øn.");
        return;
      }
      lastSentTime = now;

      if (nickname.toLowerCase() === "therealguy1201") {
        isAdmin = true;
        clearBtn.style.display = "inline-block";
      }

      let imgURL = null;
      if (file) {
        const fileRef = sRef(storage, `images/${Date.now()}_${file.name}`);
        await uploadBytes(fileRef, file);
        imgURL = await getDownloadURL(fileRef);
      }

      push(messagesRef, {
        name: nickname,
        msg: message,
        img: imgURL,
        time: new Date().toLocaleTimeString(),
        createdAt: now
      });

      messageInput.value = "";
      imageInput.value = null;
      set(typingRef, null);
      updateUserList(nickname);
    };

    window.clearChat = function () {
      if (!isAdmin) return alert("Ch·ªâ admin m·ªõi c√≥ quy·ªÅn xo√°!");
      if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° t·∫•t c·∫£ tin nh·∫Øn kh√¥ng?")) {
        remove(messagesRef);
      }
    };

    function updateUserList(name) {
      if (!activeUsers.has(name)) {
        activeUsers.add(name);
        const li = document.createElement("li");
        li.textContent = name;
        li.style.color = getColorForUser(name);
        userList.appendChild(li);
      }
    }

    function displayMessage({ name, msg, time, img }) {
      const div = document.createElement("div");
      div.className = "msg";
      div.innerHTML = `<strong style="color:${getColorForUser(name)}">${name}</strong>: ${msg || ""}`;
      if (img) {
        const imageElem = document.createElement("img");
        imageElem.src = img;
        imageElem.style.maxWidth = "200px";
        imageElem.style.display = "block";
        imageElem.style.marginTop = "5px";
        div.appendChild(imageElem);
      }
      const timeSpan = document.createElement("span");
      timeSpan.style.fontSize = "12px";
      timeSpan.style.color = "#888";
      timeSpan.textContent = ` (${time})`;
      div.appendChild(timeSpan);
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // ‚úÖ T·∫¢I TO√ÄN B·ªò TIN NH·∫ÆN L·ªäCH S·ª¨ L√öC M·ªû TRANG
    function loadChatHistory() {
      onValue(messagesRef, (snapshot) => {
        const messages = snapshot.val();
        if (!messages) return;
        chatBox.innerHTML = ""; // tr√°nh l·∫∑p l·∫°i khi reload
        Object.values(messages).forEach((msg) => {
          displayMessage(msg);
          updateUserList(msg.name);
        });
      }, { onlyOnce: true });
    }

    loadChatHistory(); // G·ªçi khi m·ªü trang

    // ‚úÖ TI·∫æP T·ª§C NGHE REALTIME TIN NH·∫ÆN M·ªöI
    onChildAdded(messagesRef, (snapshot) => {
      const msg = snapshot.val();
      displayMessage(msg);
      updateUserList(msg.name);
    });

    messageInput.addEventListener("input", () => {
      const name = nicknameInput.value.trim() || "·∫®n danh";
      set(typingRef, name);
    });

    onValue(typingRef, (snapshot) => {
      const name = snapshot.val();
      typingStatus.textContent = name ? `${name} ƒëang g√µ...` : "";
    });

    messageInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") window.sendMessage();
    });
  </script>
</body>
</html>
