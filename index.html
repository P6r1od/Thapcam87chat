<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>NM Chat Realtime</title>
  <style>
    :root {
      --bg: #f0f0f0;
      --fg: #000;
      --chat-bg: #fff;
      --right-bg: #f9f9f9;
      --border: #ccc;
    }
    body.dark {
      --bg: #1e1e1e;
      --fg: #fff;
      --chat-bg: #2c2c2c;
      --right-bg: #2c2c2c;
      --border: #555;
    }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: var(--bg);
      color: var(--fg);
    }
    .container {
      display: flex;
      height: 100vh;
    }
    .left {
      flex: 3;
      display: flex;
      flex-direction: column;
      background-color: var(--chat-bg);
      padding: 10px;
    }
    #chatBox {
      flex: 1;
      border: 1px solid var(--border);
      padding: 10px;
      overflow-y: auto;
      background-color: var(--chat-bg);
    }
    .msg {
      margin-bottom: 10px;
      word-wrap: break-word;
    }
    .msg strong {
      font-weight: bold;
    }
    .bottom-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      padding: 10px;
      background-color: var(--right-bg);
    }
    .bottom-bar input[type="text"] {
      flex: 1;
      padding: 8px;
      font-size: 16px;
      border: 1px solid #aaa;
      background-color: var(--chat-bg);
      color: var(--fg);
    }
    .bottom-bar button {
      padding: 8px 16px;
      font-size: 16px;
    }
    .right {
      flex: 1;
      background-color: var(--right-bg);
      border-left: 1px solid var(--border);
      padding: 10px;
    }
    .right h2 {
      margin-top: 0;
    }
    #userList {
      list-style: none;
      padding: 0;
      margin: 10px 0;
    }
    .typing-status {
      font-style: italic;
      color: gray;
      padding-left: 10px;
    }
    #themeToggle {
      margin-top: 10px;
      padding: 5px 10px;
      cursor: pointer;
    }
    @media (max-width: 600px) {
      .bottom-bar { flex-direction: column; }
      .bottom-bar input, .bottom-bar button { width: 100%; }
      .container { flex-direction: column; }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="left">
    <div id="chatBox"></div>
    <div id="typingStatus" class="typing-status"></div>
    <div class="bottom-bar">
      <input type="text" id="nickname" placeholder="T√™n (m·∫∑c ƒë·ªãnh: ·∫®n danh)">
      <input type="text" id="message" placeholder="Nh·∫≠p tin nh·∫Øn...">
      <input type="file" id="imageInput" accept="image/*">
      <button onclick="window.sendMessage()">G·ª≠i</button>
      <button id="clearBtn" onclick="window.clearChat()" style="display: none">üßπ X√≥a t·∫•t c·∫£</button>
      <button id="themeToggle">üåô Ch·∫ø ƒë·ªô t·ªëi</button>
    </div>
  </div>
  <div class="right">
    <p style="font-size: 12px; color: gray; font-style: italic;">
      * Tin nh·∫Øn s·∫Ω t·ª± ƒë·ªông x√≥a sau 24 gi·ªù. T√™n ng∆∞·ªùi d√πng s·∫Ω ƒë∆∞·ª£c kh√≥a trong 1 tr√¨nh duy·ªát v√† kh√¥ng ƒë∆∞·ª£c ƒë·ªïi ƒë·ªÉ tr√°nh nh·∫ßm l·∫´n. Vui l√≤ng kh√¥ng ƒë·∫∑t tr√πng t√™n, chat m·ªõi ·ªü b·∫£n beta, xin h√£y th√¥ng c·∫£m n·∫øu c√≥ l·ªói!
    </p>
    <h2>Th√†nh vi√™n</h2>
    <ul id="userList"></ul>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, remove, set, onValue } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

  const config = {
    apiKey: "AIzaSyAwz09EQouPZsgxnIQaAKiGfUKrlbbd7sM",
    authDomain: "thapcamchat.firebaseapp.com",
    databaseURL: "https://thapcamchat-default-rtdb.firebaseio.com",
    projectId: "thapcamchat",
    storageBucket: "thapcamchat.appspot.com",
    messagingSenderId: "832278442913",
    appId: "1:832278442913:web:b24e7b6d7b283e9885d1e0"
  };

  const app = initializeApp(config);
  const db = getDatabase(app);
  const storage = getStorage(app);
  const messagesRef = ref(db, "messages");
  const typingRef = ref(db, "typing");

  const chatBox = document.getElementById("chatBox");
  const messageInput = document.getElementById("message");
  const nicknameInput = document.getElementById("nickname");
  const typingStatus = document.getElementById("typingStatus");
  const userList = document.getElementById("userList");
  const clearBtn = document.getElementById("clearBtn");
  const imageInput = document.getElementById("imageInput");

  const userColorMap = JSON.parse(localStorage.getItem("userColors") || "{}");
  const activeUsers = new Set();
  let isAdmin = false;
  let lastSentTime = 0;

  function getColorForUser(name) {
    if (!userColorMap[name]) {
      userColorMap[name] = `hsl(${Math.floor(Math.random() * 360)}, 70%, 50%)`;
      localStorage.setItem("userColors", JSON.stringify(userColorMap));
    }
    return userColorMap[name];
  }

  document.getElementById("themeToggle").addEventListener("click", () => {
    document.body.classList.toggle("dark");
    const dark = document.body.classList.contains("dark");
    localStorage.setItem("theme", dark ? "dark" : "light");
    document.getElementById("themeToggle").textContent = dark ? "‚òÄÔ∏è Ch·∫ø ƒë·ªô s√°ng" : "üåô Ch·∫ø ƒë·ªô t·ªëi";
  });

  if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark");
    document.getElementById("themeToggle").textContent = "‚òÄÔ∏è Ch·∫ø ƒë·ªô s√°ng";
  }

  window.sendMessage = async function () {
    let nickname = localStorage.getItem("lockedName") || nicknameInput.value.trim() || "·∫®n danh";
    if (!localStorage.getItem("lockedName")) {
      if ([...activeUsers].includes(nickname)) {
        alert("T√™n n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng. Vui l√≤ng ch·ªçn t√™n kh√°c.");
        return;
      }
      localStorage.setItem("lockedName", nickname);
    }
    nicknameInput.value = nickname;
    nicknameInput.disabled = true;
    const message = messageInput.value.trim();
    const file = imageInput.files[0];
    if (!message && !file) return;

    const now = Date.now();
    if (now - lastSentTime < 5000) {
      alert("B·∫°n ph·∫£i ch·ªù 5 gi√¢y gi·ªØa m·ªói tin nh·∫Øn ƒë·ªÉ tr√°nh spam.");
      return;
    }
    lastSentTime = now;

    if (nickname.toLowerCase() === "therealguy1201") {
      isAdmin = true;
      clearBtn.style.display = "inline-block";
    }

    let imgURL = null;
    if (file) {
      const fileRef = sRef(storage, `images/${Date.now()}_${file.name}`);
      await uploadBytes(fileRef, file);
      imgURL = await getDownloadURL(fileRef);
    }

    push(messagesRef, {
      name: nickname,
      msg: message,
      img: imgURL || null,
      time: new Date().toLocaleTimeString(),
      createdAt: Date.now()
    });
    messageInput.value = "";
    imageInput.value = null;
    set(typingRef, null);
    updateUserList(nickname);
  }

  window.clearChat = function () {
    if (!isAdmin) return alert("Ch·ªâ admin m·ªõi ƒë∆∞·ª£c x√≥a to√†n b·ªô tin nh·∫Øn!");
    if (confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô tin nh·∫Øn kh√¥ng?")) {
      remove(messagesRef);
      localStorage.removeItem("chatBackup");
    }
  }

  function updateUserList(name) {
    if (!activeUsers.has(name)) {
      activeUsers.add(name);
      const li = document.createElement("li");
      li.textContent = name;
      li.style.color = getColorForUser(name);
      userList.appendChild(li);
    }
  }

  function displayMessage({ name, msg, time, img }) {
    const div = document.createElement("div");
    div.className = "msg";
    div.innerHTML = `<strong style="color:${getColorForUser(name)}">${name}</strong>: ${msg || ""}`;
    if (img) {
      const imageElem = document.createElement("img");
      imageElem.src = img;
      imageElem.style.maxWidth = "200px";
      imageElem.style.display = "block";
      imageElem.style.marginTop = "5px";
      div.appendChild(imageElem);
    }
    const timeSpan = document.createElement("span");
    timeSpan.style.fontSize = "12px";
    timeSpan.style.color = "#888";
    timeSpan.textContent = ` (${time})`;
    div.appendChild(timeSpan);
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  onChildAdded(messagesRef, snapshot => {
    const msgData = snapshot.val();
    displayMessage(msgData);
    updateUserList(msgData.name);
  });

  messageInput.addEventListener("input", () => {
    const nickname = nicknameInput.value.trim() || "·∫®n danh";
    set(typingRef, nickname);
  });

  onValue(typingRef, (snapshot) => {
    const name = snapshot.val();
    typingStatus.textContent = name ? `${name} ƒëang g√µ...` : "";
  });

  messageInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") window.sendMessage();
  });
</script>
</body>
</html>
