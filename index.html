<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import {
    getDatabase, ref, push, onChildAdded, remove, set, onValue
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
  import {
    getStorage, ref as sRef, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

  // Firebase cấu hình mới
  const config = {
    apiKey: "AIzaSyAwz09EQouPZsgxnIQaAKiGfUKrlbbd7sM",
    authDomain: "thapcamchat.firebaseapp.com",
    databaseURL: "https://thapcamchat-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "thapcamchat",
    storageBucket: "thapcamchat.appspot.com",
    messagingSenderId: "832278442913",
    appId: "1:832278442913:web:b24e7b6d7b283e9885d1e0"
  };

  const app = initializeApp(config);
  const db = getDatabase(app);
  const storage = getStorage(app);
  const messagesRef = ref(db, "messages");
  const typingRef = ref(db, "typing");

  const chatBox = document.getElementById("chatBox");
  const messageInput = document.getElementById("message");
  const nicknameInput = document.getElementById("nickname");
  const typingStatus = document.getElementById("typingStatus");
  const userList = document.getElementById("userList");
  const clearBtn = document.getElementById("clearBtn");
  const imageInput = document.getElementById("imageInput");

  const userColorMap = {};
  const activeUsers = new Set();
  let isAdmin = false;

  function getColorForUser(name) {
    if (!userColorMap[name]) {
      userColorMap[name] = `hsl(${Math.floor(Math.random() * 360)}, 70%, 50%)`;
    }
    return userColorMap[name];
  }

  let lastSentTime = 0;

  window.sendMessage = async function () {
    let nickname = localStorage.getItem("lockedName") || nicknameInput.value.trim() || "Ẩn danh";
    if (!localStorage.getItem("lockedName")) {
      if ([...activeUsers].includes(nickname)) {
        alert("Tên này đã được sử dụng. Vui lòng chọn tên khác.");
        return;
      }
      localStorage.setItem("lockedName", nickname);
    }
    nicknameInput.value = nickname;
    nicknameInput.disabled = true;
    const message = messageInput.value.trim();
    const file = imageInput.files[0];
    if (!message && !file) return;

    const now = Date.now();
    if (now - lastSentTime < 5000) {
      alert("Bạn phải chờ 5 giây giữa mỗi tin nhắn để tránh spam.");
      return;
    }
    lastSentTime = now;

    if (nickname.toLowerCase() === "therealguy1201") {
      isAdmin = true;
      clearBtn.style.display = "inline-block";
    }

    let imgURL = null;
    if (file) {
      const fileRef = sRef(storage, `images/${Date.now()}_${file.name}`);
      await uploadBytes(fileRef, file);
      imgURL = await getDownloadURL(fileRef);
    }

    push(messagesRef, {
      name: nickname,
      msg: message,
      img: imgURL || null,
      time: new Date().toLocaleTimeString(),
      createdAt: Date.now()
    });
    messageInput.value = "";
    imageInput.value = null;
    set(typingRef, null);
    updateUserList(nickname);
  }

  window.clearChat = function () {
    if (!isAdmin) return alert("Chỉ admin mới được xóa toàn bộ tin nhắn!");
    if (confirm("Bạn chắc chắn muốn xóa toàn bộ tin nhắn không?")) {
      remove(messagesRef);
      localStorage.removeItem("chatBackup");
    }
  }

  function updateUserList(name) {
    if (!activeUsers.has(name)) {
      activeUsers.add(name);
      const li = document.createElement("li");
      li.textContent = name;
      li.style.color = getColorForUser(name);
      userList.appendChild(li);
    }
  }

  function saveToLocal(message) {
    const history = JSON.parse(localStorage.getItem("chatBackup") || "[]");
    history.push(message);
    localStorage.setItem("chatBackup", JSON.stringify(history));
  }

  function displayMessage({ name, msg, time, img }) {
    const div = document.createElement("div");
    div.className = "msg";
    div.innerHTML = `<strong style="color:${getColorForUser(name)}">${name}</strong>: ${msg || ""}`;
    if (img) {
      const imageElem = document.createElement("img");
      imageElem.src = img;
      imageElem.style.maxWidth = "200px";
      imageElem.style.display = "block";
      imageElem.style.marginTop = "5px";
      div.appendChild(imageElem);
    }
    const timeSpan = document.createElement("span");
    timeSpan.style.fontSize = "12px";
    timeSpan.style.color = "#888";
    timeSpan.textContent = ` (${time})`;
    div.appendChild(timeSpan);
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function loadAllMessages() {
    onValue(messagesRef, (snapshot) => {
      const messages = snapshot.val();
      if (!messages) return;
      chatBox.innerHTML = "";
      localStorage.removeItem("chatBackup");
      Object.values(messages).forEach((msgData) => {
        displayMessage(msgData);
        updateUserList(msgData.name);
        saveToLocal(msgData);
      });
    }, { onlyOnce: true });
  }

  onChildAdded(messagesRef, snapshot => {
    const msgData = snapshot.val();
    displayMessage(msgData);
    updateUserList(msgData.name);
    saveToLocal(msgData);
  });

  messageInput.addEventListener("input", () => {
    const nickname = nicknameInput.value.trim() || "Ẩn danh";
    set(typingRef, nickname);
  });

  onValue(typingRef, (snapshot) => {
    const name = snapshot.val();
    typingStatus.textContent = name ? `${name} đang gõ...` : "";
  });

  messageInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") window.sendMessage();
  });

  loadAllMessages();
</script>
